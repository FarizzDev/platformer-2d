name: Export Godot Project

on:
  workflow_dispatch:
    inputs:
      godot_link:
        required: true
        default: "https://github.com/godotengine/godot/releases/download/3.6-stable/Godot_v3.6-stable_linux_headless.64.zip"
        description: "Enter Godot link:"
      templates_link:
        required: true
        default: "https://github.com/godotengine/godot/releases/download/3.6-stable/Godot_v3.6-stable_export_templates.tpz"
        description: "Enter Export Templates link:"
      preset_name:
        required: true
        default: "Android"
        description: "Enter platform:"
      debug:
        description: "Debug version"
        type: boolean
        default: false
      cache:
        description: "Cache"
        type: boolean
        default: true
      file_basename:
        description: "Base name for output files (e.g., MyGame)"
        required: true
        default: "GoduxExport"
      cert_cn:
        description: "Certificate CN (e.g., Your Name, Your Company)"
        required: false
        default: "Godux User"
      org:
        description: "Organization for Android (O)"
        required: false
        default: "Android"
      country:
        description: "2-letter Country Code for Android (C)"
        required: false
        default: "US"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GODOT_LINK: ${{ inputs.godot_link }}
      TEMPLATES_LINK: ${{ inputs.templates_link }}
      PRESET_NAME: ${{ inputs.preset_name }}
      KEYSTORE_PASS: ${{ secrets.KEYSTORE_PASS }}
      KEYSTORE_USER: ${{ secrets.KEYSTORE_USER }}
      DEBUG: ${{ inputs.debug }}
      CACHE: ${{ inputs.cache }}
      FILE_BASENAME: ${{ inputs.file_basename }}
      CERT_CN: ${{ inputs.cert_cn }}
      ORG: ${{ inputs.org }}
      COUNTRY: ${{ inputs.country }}

    steps:
      - name: ðŸ›’ Checkout repository
        uses: actions/checkout@v3

      - name: âš™ï¸ Prepare
        run: |
          if [ ! -f export_presets.cfg ]; then
            echo "Error: File export_presets.cfg not found."
            exit 1
          fi

          # Determine if any Android build is happening
          if [ "$PRESET_NAME" = $'[ Export All Preset ]\u2063' ]; then
            ISANDROID=$(grep -q 'platform="Android"' export_presets.cfg && echo "true")
          else
            # Check if the selected preset is an Android preset
            ISANDROID=$(awk -v preset_name="$PRESET_NAME" '
              BEGIN { FS = "[[:space:]]*=[[:space:]]*"; in_preset=0; is_android=0 }
              /^\[preset\./ { in_preset=0 }
              /^name[[:space:]]*=/ {
                n=$2; gsub(/"/, "", n)
                if (n == preset_name) in_preset=1
              }
              in_preset && /^platform[[:space:]]*=/ {
                p=$2; gsub(/"/, "", p)
                if (p == "Android") { is_android=1 }
              }
              END { if (is_android) print "true" }
            ' export_presets.cfg)
          fi

          echo "ISANDROID=${ISANDROID:-false}" >> "$GITHUB_ENV"

          VERSION=$(echo ${{ env.GODOT_LINK }} | sed -E 's|.*\/([0-9.]+)-([a-z0-9]+).*|\1.\2|')
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: ðŸ“ Godot Export Templates Cache
        if: env.CACHE == 'true'
        uses: actions/cache@v4
        id: templates-cache
        with:
          path: ~/.local/share/godot/templates/${{ env.VERSION }}
          key: ${{ runner.os }}-godot-templates-${{ env.VERSION }}

      - name: ðŸ“¥ Download Godot
        run: |
          wget $GODOT_LINK -O godot.zip
          unzip godot.zip
          sudo mv Godot_* /usr/local/bin/godot
          chmod +x /usr/local/bin/godot

      - name: ðŸ“¤ Extract Godot Export Templates
        if: env.CACHE == 'false' || steps.templates-cache.outputs.cache-hit != 'true'
        run: |
          curl -L $TEMPLATES_LINK -o godot-templates.tpz
          mkdir -p ~/.local/share/godot/templates/${{ env.VERSION }}
          unzip godot-templates.tpz -d temp_templates
          cp -r temp_templates/templates/. ~/.local/share/godot/templates/${{ env.VERSION }}/
          rm -rf temp_templates godot-templates.tpz

      - name: ðŸ—ï¸ Prepare Android Build Folder
        if: env.ISANDROID == 'true'
        run: |
          TEMPLATE_PATH="$HOME/.local/share/godot/templates/${{ env.VERSION }}"

          rm -rf android/build
          mkdir -p android/build

          unzip -o "$TEMPLATE_PATH/android_source.zip" -d android/build/

          echo "${{ env.VERSION }}" > android/build/.build_version

          chmod +x android/build/gradlew
          echo "âœ… Android Build folder is ready with version: ${{ env.VERSION }}"

          echo "=== CHECKING ANDROID BUILD STRUCTURE ==="
          ls -la android/build/
          echo "=== CHECKING .build_version CONTENT ==="
          cat android/build/.build_version || echo "File .build_version TIDAK DITEMUKAN"

      - name: â˜• Setup JDK 17 (For SDK Tools)
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: ðŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: "platforms;android-34 build-tools;34.0.0 platform-tools cmdline-tools;latest ndk;23.1.7779620"

      - name: â˜• Switch to JDK 11 (For Godot 3 Export)
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "11"

      - name: ðŸ“ Get Keystore Paths
        if: env.ISANDROID == 'true'
        run: |
          DEBUG_KEYSTORE_PATH=$(awk -F'=' '/keystore/debug=/{gsub(/"/, "", $2); gsub(/res:\/\//, "", $2); print $2}' export_presets.cfg | head -n 1)
          RELEASE_KEYSTORE_PATH=$(awk -F'=' '/keystore/release=/{gsub(/"/, "", $2); gsub(/res:\/\//, "", $2); print $2}' export_presets.cfg | head -n 1)
          echo "DEBUG_KEYSTORE_PATH=${DEBUG_KEYSTORE_PATH:-debug.keystore}" >> $GITHUB_ENV
          echo "RELEASE_KEYSTORE_PATH=${RELEASE_KEYSTORE_PATH:-release.keystore}" >> $GITHUB_ENV

      - name: ðŸ”‘ Setup Keystore (For Android)
        if: env.ISANDROID == 'true'
        env:
          RELEASE_KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
        run: |
          if [ -n "$RELEASE_KEYSTORE_BASE64" ]; then
            echo "Decoding and placing existing keystore at ${{ env.RELEASE_KEYSTORE_PATH }}"
            mkdir -p "$(dirname "${{ env.RELEASE_KEYSTORE_PATH }}")"
            echo "$RELEASE_KEYSTORE_BASE64" | base64 --decode > "${{ env.RELEASE_KEYSTORE_PATH }}"
          elif [ "${{ env.DEBUG }}" = "false" ]; then
            echo "Generating new release keystore at ${{ env.RELEASE_KEYSTORE_PATH }}"
            mkdir -p "$(dirname "${{ env.RELEASE_KEYSTORE_PATH }}")"
            keytool -genkey -v -keystore "${{ env.RELEASE_KEYSTORE_PATH }}" -alias "${{ env.KEYSTORE_USER }}" -storepass "${{ env.KEYSTORE_PASS }}" -keypass "${{ env.KEYSTORE_PASS }}" -dname "CN=${{ env.CERT_CN }},O=${{ env.ORG }},C=${{ env.COUNTRY }}" -keyalg RSA -keysize 2048 -validity 10000
          fi
          echo "Generating debug keystore at ${{ env.DEBUG_KEYSTORE_PATH }}"
          mkdir -p "$(dirname "${{ env.DEBUG_KEYSTORE_PATH }}")"
          keytool -genkey -v -keystore "${{ env.DEBUG_KEYSTORE_PATH }}" -alias androiddebugkey -storepass android -keypass android -dname "CN=${{ env.FILE_BASENAME }} (Debug),O=Android,C=US" -keyalg RSA -keysize 2048 -validity 9000

      - name: ðŸ›  Export
        run: |
          mkdir -p export
          EXPORT_FLAG=$([[ "${{ env.DEBUG }}" == "true" ]] && echo "--export-debug" || echo "--export")

          get_android_ext() {
            local search_name="$1"
            
            local format=$(awk -v ref="$search_name" '
              BEGIN { FS="="; in_p=0; res="0" }
              
              /^\[preset\./ { in_p=0 }
              
              /name="/ { 
                n=$2; gsub(/"/, "", n); 
                gsub(/^[[:space:]]+|[[:space:]]+$/, "", n);
                if (n == ref) in_p=1 
              }
              
              in_p && /export_format/ { 
                v=$2; gsub(/[[:space:]\r]/, "", v); 
                res=v; 
                exit 
              }
              
              END { print res }
            ' export_presets.cfg)

            if [[ "$format" == "1" ]]; then echo "aab"; else echo "apk"; fi
          }

          if [ "$PRESET_NAME" = $'[ Export All Preset ]\u2063' ]; then
            presets=$(awk '
              BEGIN { FS = "[[:space:]]*=[[:space:]]*" }
              /^\[preset\./ { if (n&&p) print n"|"p; n=""; p="" }
              /^name/ { n=$2; gsub(/"/, "", n) }
              /^platform/ { p=$2; gsub(/"/, "", p) }
              END { if (n&&p) print n"|"p }
            ' export_presets.cfg)

            while IFS='|' read -r p_name p_type; do
              echo "Exporting '$p_name'..."
              subfolder=$(echo "$p_type" | tr '[:upper:]' '[:lower:]' | tr -d '[:space:]' | sed 's|/x11||')
              mkdir -p "export/$subfolder"
              
              case "$p_type" in
                "Android") EXT=$(get_android_ext "$p_name"); OUTPUT_PATH="export/$subfolder/${{ env.FILE_BASENAME }}.$EXT" ;; 
                "Windows Desktop") OUTPUT_PATH="export/$subfolder/${{ env.FILE_BASENAME }}.exe" ;; 
                "Linux/X11") OUTPUT_PATH="export/$subfolder/${{ env.FILE_BASENAME }}" ;; 
                "HTML5") OUTPUT_PATH="export/$subfolder/index.html" ;; 
                "Mac OSX") OUTPUT_PATH="export/$subfolder/${{ env.FILE_BASENAME }}.zip" ;; 
                *) OUTPUT_PATH="export/$subfolder/${{ env.FILE_BASENAME }}" ;;
              esac
              echo "--------------------------"
              echo "DEBUG: Preset detected as: $PRESET_NAME"
              echo "DEBUG: Platform detected as: $PLATFORM"
              echo "DEBUG: Determined Extension: $EXT"
              echo "DEBUG: Full Output Path: $OUTPUT_PATH"
              echo "--------------------------"
              godot $EXPORT_FLAG "$p_name" "export/android/Platformer.aab"
            done <<< "$presets"

          else
            PLATFORM=$(awk -v ref="$PRESET_NAME" '
              /^\[preset\./ { n=""; p="" }
              /^name=/      { n=$0; gsub(/.*="/,"",n); gsub(/".*/,"",n) }
              /^platform=/  { p=$0; gsub(/.*="/,"",p); gsub(/".*/,"",p) }
              n==ref && p { print p; exit }
            ' export_presets.cfg)

            subfolder=$(echo "$PLATFORM" | tr '[:upper:]' '[:lower:]' | tr -d '[:space:]' | sed 's|/x11||')
            mkdir -p "export/$subfolder"
            
            OUTPUT_PATH="export/$subfolder/${{ env.FILE_BASENAME }}"
            if [[ "$PLATFORM" == "Android"* ]]; then
              EXT=$(get_android_ext "$PRESET_NAME")
              OUTPUT_PATH="export/$subfolder/${{ env.FILE_BASENAME }}.$EXT"
            elif [ "$PLATFORM" = "Windows Desktop" ]; then
              OUTPUT_PATH="export/$subfolder/${{ env.FILE_BASENAME }}.exe"
            elif [ "$PLATFORM" = "Linux/X11" ]; then
              OUTPUT_PATH="export/$subfolder/${{ env.FILE_BASENAME }}"
            elif [ "$PLATFORM" = "HTML5" ]; then
              OUTPUT_PATH="export/$subfolder/index.html"
            elif [ "$PLATFORM" = "Mac OSX" ]; then
              OUTPUT_PATH="export/$subfolder/${{ env.FILE_BASENAME }}.zip"
            fi
            
            echo "--------------------------"
            echo "DEBUG: Preset detected as: $PRESET_NAME"
            echo "DEBUG: Platform detected as: $PLATFORM"
            echo "DEBUG: Determined Extension: $EXT"
            echo "DEBUG: Full Output Path: $OUTPUT_PATH"
            echo "--------------------------"
            godot $EXPORT_FLAG "$PRESET_NAME" "export/android/Platformer.aab"
          fi

          if [[ "$ISANDROID" == "true" && "${{ env.DEBUG }}" == "false" ]]; then
            cp "${{ env.RELEASE_KEYSTORE_PATH }}" export/android/ 2>/dev/null || true
          fi

          find export -name "*.keystore" -type f -delete

          zip -r -7 "${{ env.FILE_BASENAME }}.zip" export/

      - name: ðŸš€ Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release create "build-${{ github.run_id }}" "${{ env.FILE_BASENAME }}.zip" --notes "Automated build from GitHub Actions"
